#!/usr/bin/env bash

# Install nix
if [ ! -x "$(command -v nix)" ]; then
  os_type=$(uname)

  if [ $os_type == "Darwin" ]; then
    curl -L https://releases.nixos.org/nix/nix-2.19.3/install | sh -s
  elif [ $os_type == "Linux" ]; then
    curl -L https://releases.nixos.org/nix/nix-2.19.3/install | sh -s -- --daemon
  else
      echo "Unsupported OS"
      exit 1
  fi
else
  echo "Info: nix has already installed! Skip."
fi

# Enable nix-command and flakes
config="experimental-features = nix-command flakes"
path_to_nix_config=~/.config/nix/nix.conf
if [ ! -f "$path_to_nix_config" ] || ! grep -q "$config" $path_to_nix_config; then
  mkdir -p $(dirname $path_to_nix_config)
  echo "$config" >> $path_to_nix_config
else
  echo "Info: ${path_to_nix_config} has already support nix flake! Skip."
fi

# Specify the version of nixpkgs
nix_version_name=nixos-23.11
nix_version=https://nixos.org/channels/nixos-23.11
if [[ "$(nix-channel --list | grep "$nix_version_name" | cut -d ' ' -f 2)" == "${nix_version}" ]]; then
  echo "Info: ${nix_version_name} ${nix_version} already exists! Skip."
else
  echo "Info: ${nix_version_name} ${nix_version} does not exist! Updating..."
  nix-channel --remove "$nix_version_name"
  nix-channel --add "$nix_version"
  nix-channel --update
fi
